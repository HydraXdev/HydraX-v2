version: '3.8'

services:
  # Market Prediction API
  market-prediction-api:
    build:
      context: .
      dockerfile: Dockerfile.market_prediction
    ports:
      - "5000:5000"
    environment:
      - ALPHA_VANTAGE_KEY=${ALPHA_VANTAGE_KEY:-demo}
      - NEWSAPI_KEY=${NEWSAPI_KEY:-demo}
      - REDDIT_CLIENT_ID=${REDDIT_CLIENT_ID:-demo}
      - REDDIT_CLIENT_SECRET=${REDDIT_CLIENT_SECRET:-demo}
      - TWITTER_BEARER_TOKEN=${TWITTER_BEARER_TOKEN:-}
    volumes:
      - ./logs:/app/logs
      - ./cache:/app/cache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis for caching (optional but recommended)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes

  # Nginx reverse proxy (optional)
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - market-prediction-api
    restart: unless-stopped

volumes:
  redis-data:

# Example nginx.conf for reference:
# server {
#     listen 80;
#     server_name your-domain.com;
#     
#     location / {
#         proxy_pass http://market-prediction-api:5000;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }